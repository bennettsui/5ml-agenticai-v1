name: Fly Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy app to Fly.io
    runs-on: ubuntu-latest
    concurrency:
      group: fly-deploy-group
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Build image once
        id: build
        run: |
          # Build and push the Docker image to Fly's registry once.
          # Capture the image reference so retries reuse the same build.
          IMAGE=$(flyctl deploy --remote-only --build-only --json 2>/dev/null \
            | grep -o '"image":"[^"]*"' | head -1 | cut -d'"' -f4)

          if [ -z "$IMAGE" ]; then
            # Fallback: build-only without JSON and parse the pushed image ref
            OUTPUT=$(flyctl deploy --remote-only --build-only 2>&1)
            echo "$OUTPUT"
            IMAGE=$(echo "$OUTPUT" | grep -oP 'registry\.fly\.io/[^\s]+' | tail -1)
          fi

          if [ -z "$IMAGE" ]; then
            echo "::error::Could not determine built image reference"
            exit 1
          fi

          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "Built image: $IMAGE"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy to Fly.io (with retry for lease conflicts)
        run: |
          IMAGE="${{ steps.build.outputs.image }}"

          for i in 1 2 3; do
            echo "Deployment attempt $i (image: $IMAGE)..."
            if flyctl deploy --image "$IMAGE" \
                --lease-timeout=5m \
                --wait-timeout=8m \
                --strategy rolling; then
              echo "Deployment successful on attempt $i"
              exit 0
            fi

            EXIT_CODE=$?
            echo "Attempt $i failed (exit $EXIT_CODE)"

            if [ $i -lt 3 ]; then
              WAIT=$((45 * i))
              echo "Waiting ${WAIT}s before retry..."
              sleep $WAIT
            fi
          done

          echo "::error::All 3 deployment attempts failed"
          exit 1
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
